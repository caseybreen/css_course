<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Casey Breen">
<meta name="dcterms.date" content="2025-02-17">

<title>Topics in Computational Social Science - Lab 3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="css_lab3_solutions_files/libs/clipboard/clipboard.min.js"></script>
<script src="css_lab3_solutions_files/libs/quarto-html/quarto.js"></script>
<script src="css_lab3_solutions_files/libs/quarto-html/popper.min.js"></script>
<script src="css_lab3_solutions_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="css_lab3_solutions_files/libs/quarto-html/anchor.min.js"></script>
<link href="css_lab3_solutions_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="css_lab3_solutions_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="css_lab3_solutions_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="css_lab3_solutions_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="css_lab3_solutions_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Topics in Computational Social Science - Lab 3</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Casey Breen </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 17, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="lab-3-non-probability-sampling" class="level2">
<h2 class="anchored" data-anchor-id="lab-3-non-probability-sampling">Lab 3: Non-probability sampling</h2>
<p>In this lab, we will explore different statistical methods for adjusting non-probability samples to improve their representativeness of the population of interest.</p>
<p>Non-probability sampling is increasingly common approach to data collection. While probability sampling is generally recommended whenever possible, logistical or financial challenges often preclude researchers from collecting a probability sample. For an overview of non-probability sampling in the social sciences, see:</p>
<ul>
<li><p>Baker, Reg, J. Michael Brick, Nancy A. Bates, Mike Battaglia, Mick P. Couper, Jill A. Dever, Krista J. Gile, and Roger Tourangeau. 2013. ‘Summary Report of the AAPOR Task Force on Non-Probability Sampling’. Journal of Survey Statistics and Methodology 1(2):90–143. <a href="https://doi.org/10.1093/jssam/smt008" class="uri">https://doi.org/10.1093/jssam/smt008</a>.</p></li>
<li><p>Kennedy, Andrew Mercer, Arnold Lau and Courtney. 2018. ‘For Weighting Online Opt-In Samples, What Matters Most?’ Pew Research Center. Retrieved 10 February 2025 (<a href="https://www.pewresearch.org/methods/2018/01/26/for-weighting-online-opt-in-samples-what-matters-most/" class="uri">https://www.pewresearch.org/methods/2018/01/26/for-weighting-online-opt-in-samples-what-matters-most/</a>).</p></li>
<li><p>Lehdonvirta, Vili, Atte Oksanen, Pekka Räsänen, and Grant Blank. 2021. ‘Social Media, Web, and Panel Surveys: Using Non-Probability Samples in Social and Policy Research’. Policy &amp; Internet 13(1):134–55. <a href="https://www.doi.org/10.1002/poi3.238" class="uri">https://www.doi.org/10.1002/poi3.238</a></p></li>
</ul>
<p>In the first exercise, we will use simulated data and construct post-stratification weights. This will help us understand the role of weighting adjustments in improving the representativeness of non-probability samples. In the second exercise, we will estimate crude death rates using a non-probability sample.</p>
</section>
<section id="exercise-1" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1">Exercise 1</h2>
<p>In this exercise, we’ll construct post-stratification weights for a simulated convenience sample. A <em>post-stratification weight</em> is a type of survey weight, a numeric value assigned to each respondent in a survey to adjust for unequal probabilities of selection.</p>
<p>The big-picture goal of constructing survey weights is to adjust the sample so that it more accurately represents the population of interest. This is particularly important samples, where certain groups are highly over- or underrepresented due to selection biases.</p>
<p>There are many different methods for generating survey weights, and each method comes with a set of tradeoffs. The ‘right’ weighting strategy depends on the availability of auxiliary data, the sampling design, and the specific biases the researcher aims to correct. Ideally, the chosen weighting strategy will improve representativeness by aligning the sample with known population characteristics, while minimizing variance and other biases in estimating population-level parameters.</p>
<p>This (hypothetical) convenience sample was conducted at a coffee shop. The goal of survey is to estimate the average daily coffee consumption in cups among adults in Melbourne, Australia: respondents were asked about their age, income, and daily coffee consumption.</p>
<p>To help construct the post-stratification weights, we’ve also obtained auxiliary city-level data on the proportion of people aged 18+ in each age X income group (“strata”) in Melbourne. We will use this auxiliary data to help construct the post-stratification weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## library packages </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we’ll load in our data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read in sample data </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>coffee_shop_sample <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">age_group =</span> <span class="fu">c</span>(<span class="st">"50+"</span>,<span class="st">"50+"</span>,<span class="st">"30-49"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"50+"</span>,<span class="st">"18-29"</span>,<span class="st">"18-29"</span>,<span class="st">"18-29"</span>,<span class="st">"30-49"</span>,<span class="st">"18-29"</span>,<span class="st">"18-29"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"18-29"</span>,<span class="st">"18-29"</span>,<span class="st">"50+"</span>,<span class="st">"30-49"</span>,<span class="st">"18-29"</span>,<span class="st">"50+"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"50+"</span>,<span class="st">"30-49"</span>,<span class="st">"18-29"</span>,<span class="st">"18-29"</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">income_group =</span> <span class="fu">c</span>(<span class="st">"High"</span>,<span class="st">"Middle"</span>,<span class="st">"High"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"High"</span>,<span class="st">"Middle"</span>,<span class="st">"Low"</span>,<span class="st">"Middle"</span>,<span class="st">"High"</span>,<span class="st">"Middle"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"High"</span>,<span class="st">"Low"</span>,<span class="st">"High"</span>,<span class="st">"Middle"</span>,<span class="st">"Low"</span>,<span class="st">"Middle"</span>,<span class="st">"High"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Middle"</span>,<span class="st">"Middle"</span>,<span class="st">"High"</span>,<span class="st">"Low"</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">coffee_consumption =</span> <span class="fu">c</span>(<span class="fl">2.7</span>,<span class="fl">1.2</span>,<span class="fl">2.8</span>,<span class="fl">4.2</span>,<span class="fl">4.9</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                         <span class="fl">2.6</span>,<span class="fl">2.7</span>,<span class="fl">1.2</span>,<span class="fl">3.5</span>,<span class="fl">2.4</span>,<span class="fl">3.5</span>,<span class="fl">3.7</span>,<span class="dv">4</span>,<span class="fl">2.4</span>,<span class="fl">3.5</span>,<span class="fl">1.3</span>,<span class="fl">2.2</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                         <span class="fl">2.1</span>,<span class="fl">0.6</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll also load our auxiliary data from the city on the true proportion of people in each group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read in auxiliary population proportions </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pop_proportion <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_proportion =</span> <span class="fu">c</span>(<span class="fl">0.12</span>, <span class="fl">0.2</span>, <span class="fl">0.08</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_group =</span> <span class="fu">c</span>(<span class="st">"18-29"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"30-49"</span>,<span class="st">"50+"</span>,<span class="st">"18-29"</span>,<span class="st">"30-49"</span>,<span class="st">"50+"</span>,<span class="st">"18-29"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"30-49"</span>,<span class="st">"50+"</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">income_group =</span> <span class="fu">c</span>(<span class="st">"Low"</span>,<span class="st">"Low"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Low"</span>,<span class="st">"Middle"</span>,<span class="st">"Middle"</span>,<span class="st">"Middle"</span>,<span class="st">"High"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"High"</span>,<span class="st">"High"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="constructing-post-stratification-weights" class="level2">
<h2 class="anchored" data-anchor-id="constructing-post-stratification-weights">Constructing post-stratification weights</h2>
<p>Post-stratification weighting is a statistical re-weighting approach used to correct for differences between a sample and the population of interest. Specifically, the sample is split into mutually exclusive groups (“cells”) based on characteristics (e.g., age, gender, and income). Intuitively, the respondents in each cell have an inclusion probability equal to the ratio of the sample proportion to the population proportion.</p>
<p>The weight for each group is then calculated as the inverse of this relative inclusion probability; this ensures that underrepresented groups receive higher weights while overrepresented groups receive lower weights.</p>
<p><span class="math display">\[
\text{Weight}_{\text{cell}} = \frac{\text{Population Proportion}_{\text{cell}}}{\text{Sample Proportion}_{\text{cell}}}
\]</span> When implementing post-stratification in practice, it’s important that your sample collects the same information as is available in the auxiliary population data you will weight against. That is, design your survey instrument in such a way to collect all the data you’ll need to construct survey weights!</p>
<p>The code below defines strata based on income and age and generates post-stratification weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate sample proportion </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sample_proportion <span class="ot">&lt;-</span> coffee_shop_sample <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(income_group, age_group) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_proportion =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="do">## join population proportions together </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>poststrat_weights <span class="ot">&lt;-</span> sample_proportion <span class="sc">%&gt;%</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(pop_proportion, <span class="at">by =</span> <span class="fu">join_by</span>(age_group, income_group)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inclusion_prop =</span> sample_proportion <span class="sc">/</span> pop_proportion) <span class="sc">%&gt;%</span> <span class="do">## calculate inclusion probably by cell </span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="dv">1</span> <span class="sc">/</span> inclusion_prop) <span class="sc">%&gt;%</span>                         <span class="do">## calculate weight </span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age_group, income_group, weight)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="do">## normalize weights </span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>poststrat_weights <span class="ot">&lt;-</span> poststrat_weights <span class="sc">%&gt;%</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’ll join these post-stratification weights back onto our sample. We will also standardize the weights by dividing each weight by the average weight. This standardization step ensures that the average weight is 1, which is helpful when calculating weighted sums and averages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## add on weights </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>sample_data_weighted <span class="ot">&lt;-</span> coffee_shop_sample <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(poststrat_weights, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age_group"</span>, <span class="st">"income_group"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## normalize weights so average weight is 1 </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sample_data_weighted <span class="ot">&lt;-</span> sample_data_weighted <span class="sc">%&gt;%</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> weight<span class="sc">/</span><span class="fu">mean</span>(weight)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercise-1-questions" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1-questions">Exercise 1 questions</h2>
<ol type="1">
<li>Make a histogram of the distribution of the weights using <code>ggplot()</code> and <code>geom_histogram()</code></li>
<li>Calculate the mean (average) weight. Did our standardization work?</li>
<li>Estimate the number of cups of coffee consumed daily. Is the weighted or unweighted estimate larger?</li>
<li>Do we trust our new weighted estimates of the average number of coffee drinkers? In what ways might our re-weighted sample still differ from the general population?</li>
</ol>
<section id="exercise-1-solutions" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-solutions">Exercise 1 solutions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.1 </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sample_data_weighted <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight)) <span class="sc">+</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="css_lab3_solutions_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.2 </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>sample_data_weighted <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">mean</span>(weight))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  mean(weight)
1            1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.3 </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sample_data_weighted <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">unweighted =</span> <span class="fu">mean</span>(coffee_consumption),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">weighted =</span> <span class="fu">sum</span>(coffee_consumption <span class="sc">*</span> weight) <span class="sc">/</span> <span class="fu">sum</span>(weight)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  unweighted weighted
1      2.725 2.506159</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.3 (alternative) </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sample_data_weighted <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">unweighted =</span> <span class="fu">mean</span>(coffee_consumption),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">weighted =</span> <span class="fu">mean</span>(coffee_consumption <span class="sc">*</span> weight)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  unweighted weighted
1      2.725 2.506159</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.4 </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Answer: No, we are sampling in a coffee shop. Holding constant age and gender, </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># people in a coffee shop are going to likely going to drink substantially more</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more coffee on average than a member of the general population. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercise-2" class="level2">
<h2 class="anchored" data-anchor-id="exercise-2">Exercise 2</h2>
<p><strong><em>Estimating crude death rates with a non-probability sample</em></strong></p>
<p>In Exercise 2, we are going to apply a new method for estimating death rates in humanitarian emergencies. This new method combines the <em>network survival method</em> (described below) with a non-probability sample (the type of sample researchers can realistically collect in a humanitarian emergency, such as a civil war). In such humanitarian emergencies, researchers often face significant barriers to collecting probability samples, making non-probability approaches necessary.</p>
<p>The data collected for this exercise come from the Tanganyika Province of the Democratic Republic of the Congo (DRC). Supervised survey enumerators collected data from major transit and economic hubs, including taxi stations, ports, markets, and hospitals using a quota sample design. The quotas were established based on gender and geographic region.</p>
<p>In this exercise, we will assess the impact of different weighting strategies on crude death rate estimates. Specifically, we will apply two different weighting techniques: post-stratification and inverse-probability weighting.</p>
<p>We want to construct weights as we suspect that the respondents in our non-probability sample may systematically differ people in the general population with respect to mortality in their social networks.</p>
<p>To begin, we’ll read in the data we’ll need for this analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read in our data </span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../../data/network_survival_quota_sample.csv"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2224 Columns: 19
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (11): marital_status, education_level, material_house, cooking_fuel, bed...
dbl  (8): num_deaths_neighbours, num_deaths_kin, num_total_neighbour, num_to...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read in post-stratification weights (update path)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>poststrat_weighting_targets <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../../data/weighting_targets_poststrat.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 78 Columns: 4
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (3): gender, age_class, health_zone
dbl (1): population

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## probability sample </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>probability_sample <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../../data/network_survival_probability_sample.csv"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 7325 Columns: 20
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (13): _submission__uuid, gender, age_class, age_u5_count, age_5_18_count...
dbl  (7): hh_size, age_u5, age_5_18, age_18plus, modern_fuel_type, manufactu...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>Our survey asks respondents to report on two different social networks:</p>
<ul>
<li><p>Closest neighbours (five closest households by walking distance)</p></li>
<li><p>Kin (children, siblings, parents, grandparents, grandchildren, aunts/uncles)</p></li>
</ul>
<p>For both groups, we have information for each survey respondent about (i) number of people in each group that they are connected to and (ii) number of people in each group that died in the past 120 days.</p>
</section>
<section id="network-survival" class="level2">
<h2 class="anchored" data-anchor-id="network-survival">Network survival</h2>
<p>We will estimate a crude death rate, expressed as total deaths per 10,000 person days. This is the conventional way actors in humanitarian spaces express crude death rates; it contrasts with the conventional demographic definition of deaths per 1,000 person-years.</p>
<p>To produce an <em>estimate</em> of the crude death rate (our <em>estimand</em> of interest), we use the following <em>estimator</em>:</p>
<p><span class="math display">\[
\widehat{M} = \left( \frac{\sum_{i \in s} w_i~y_{i, D} } {\sum_{i \in s} w_i~d_i~E_{i} } \right) \times 10,000.
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(y_{i, D}\)</span> is the total number of deaths reported by respondent <span class="math inline">\(D\)</span></p></li>
<li><p><span class="math inline">\(d_i\)</span> is the degree (e.g., number of kin that respondent <span class="math inline">\(i\)</span> is connected to)</p></li>
<li><p><span class="math inline">\(E_i\)</span> is the number of days of exposure that respondent <span class="math inline">\(i\)</span> reported (in this case, 120 days)</p></li>
<li><p><span class="math inline">\(\sum_{i \in s}\)</span> is the sum over every person <span class="math inline">\(i\)</span> the sample <span class="math inline">\(s\)</span></p></li>
</ul>
<p>To illustrate, let’s focus on kin network. Calculating a death rate requires two components, the number of deaths and the measure of exposure.</p>
<ul>
<li><p>Number of deaths: this is simply the weighted total number of kin deaths reported by everyone in the sample.</p></li>
<li><p>Measure of exposure: this is the sum of the weighted total number of kin reported by everyone in the sample, multiplied by their number of days of exposure they’re reporting on (120 days, in this study).</p></li>
</ul>
<p>The crude death rate is then obtained by dividing the total number of deaths by the total exposure and multiplying by 10,000 to express the rate in deaths per 10,000 person days.</p>
<p>We will compute this separately for the kin and neighbour ties, producing two distinct estimates of the crude death rate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate crude death rate (using neighbour ties)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(num_deaths_kin)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">kin_death_rate_numerator =</span> <span class="fu">sum</span>(num_deaths_kin), <span class="do">## sum up all kin deaths </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">kin_death_rate_denominator =</span> <span class="fu">sum</span>(num_total_kin) <span class="sc">*</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span>  <span class="do">## sum up all kin and multiply by 120 days of exposure </span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">death_rate =</span> <span class="dv">10000</span> <span class="sc">*</span> (kin_death_rate_numerator<span class="sc">/</span>kin_death_rate_denominator))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  kin_death_rate_numerator kin_death_rate_denominator death_rate
                     &lt;dbl&gt;                      &lt;dbl&gt;      &lt;dbl&gt;
1                      240                    7114320      0.337</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate crude death rate (using neighbour ties)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(num_deaths_neighbours)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">neighbour_death_rate_numerator =</span> <span class="fu">sum</span>(num_deaths_neighbours), <span class="do">## sum up all kin deaths </span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">neighbour_death_rate_denominator =</span> <span class="fu">sum</span>(num_total_neighbour) <span class="sc">*</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span>  <span class="do">## sum up all kin and multiply by 120 days of exposure </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">death_rate =</span> <span class="dv">10000</span> <span class="sc">*</span> (neighbour_death_rate_numerator<span class="sc">/</span>neighbour_death_rate_denominator))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  neighbour_death_rate_numerator neighbour_death_rate_denominator death_rate
                           &lt;dbl&gt;                            &lt;dbl&gt;      &lt;dbl&gt;
1                            232                          7880760      0.294</code></pre>
</div>
</div>
<p>As we’re going to estimate the crude death rate many times in this analysis, let’s write a dedicated function to make things simpler. The function will have a few different arguments, including:</p>
<ul>
<li><p><code>deaths</code>: the column for reported deaths for the social network (i.e., kin or neighbour deaths)</p></li>
<li><p><code>degree</code>: the column for reported connections in the social network (i.e., network or neighbour degree)</p></li>
<li><p><code>weights</code>: the column for weights</p></li>
<li><p><code>exposure_days</code> the number of days of exposure reported by each person (i.e., how long the mortality report window is in days)</p></li>
</ul>
<p>If no weights are supplied, this function will generate unweighted estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## network survival estimator function </span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>network_survival_estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data, deaths, degree, <span class="at">weights =</span> <span class="cn">NULL</span>, <span class="at">exposure_days =</span> <span class="dv">120</span>) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate cdr </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">death_rate_numerator =</span> <span class="fu">sum</span>(<span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(weights)) .data[[weights]] <span class="sc">*</span> .data[[deaths]] <span class="cf">else</span> .data[[deaths]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">death_rate_denominator =</span> <span class="fu">sum</span>(<span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(weights)) .data[[weights]] <span class="sc">*</span> .data[[degree]] <span class="cf">else</span> .data[[degree]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> exposure_days</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">death_rate =</span> <span class="dv">10000</span> <span class="sc">*</span> (death_rate_numerator <span class="sc">/</span> death_rate_denominator))</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s practice applying the function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate kin crude death rate  </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>kin_estimates <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">deaths =</span> <span class="st">"num_deaths_kin"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">degree =</span> <span class="st">"num_total_kin"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"kin"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate neighbour crude death rate </span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>neighbour_estimates <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">deaths =</span> <span class="st">"num_deaths_neighbours"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">degree =</span> <span class="st">"num_total_neighbour"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">weights =</span> <span class="cn">NULL</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"neighbour"</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate crude death rate  </span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>cdr_unweighted <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(kin_estimates, neighbour_estimates) <span class="sc">%&gt;%</span> </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weights =</span> <span class="st">"Unweighted"</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>cdr_unweighted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  death_rate_numerator death_rate_denominator death_rate tie       weights   
                 &lt;dbl&gt;                  &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;     
1                  240                7117080      0.337 kin       Unweighted
2                  232                7880760      0.294 neighbour Unweighted</code></pre>
</div>
</div>
<section id="poststratification-weights" class="level4">
<h4 class="anchored" data-anchor-id="poststratification-weights">Poststratification weights</h4>
<p>First, we’ll construct poststratification weights. We’ll use the same general approach as we did in Exercise 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Look at weighting targets </span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>poststrat_weighting_targets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 78 × 4
   gender age_class health_zone population
   &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;            &lt;dbl&gt;
 1 f      [25,35)   Kalemie         17886.
 2 f      [25,35)   Nyunzu          13278.
 3 f      [25,35)   Nyemba          22989.
 4 f      [25,35)   Kalemie         15550.
 5 f      [25,35)   Nyunzu          11544.
 6 f      [25,35)   Nyemba          19984.
 7 f      [35,45)   Kalemie         10983.
 8 f      [35,45)   Nyunzu           8154.
 9 f      [35,45)   Nyemba          14116.
10 f      [35,45)   Kalemie          6676.
# ℹ 68 more rows</code></pre>
</div>
</div>
<p>We’ll construct the post-stratification weights using strata defined by <code>age_class</code> and <code>gender</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Poststratification population proporitons </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>poststrat_population <span class="ot">&lt;-</span> poststrat_weighting_targets <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_class, gender) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">sum</span>(population), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop_pop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Poststratification sample proportions </span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>poststrat_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_class, gender) <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop_sample =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate poststratification weights</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>poststrat_weights <span class="ot">&lt;-</span> poststrat_sample <span class="sc">%&gt;%</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(poststrat_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age_class"</span>, <span class="st">"gender"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> prop_pop <span class="sc">/</span> prop_sample) <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(gender, age_class, <span class="at">weight_poststrat =</span> weight)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Joining the poststratification weights back into survey_df</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(poststrat_weights, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"gender"</span>, <span class="st">"age_class"</span>)) </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="do">## standardize weights so mean is 1 </span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_poststrat =</span> weight_poststrat <span class="sc">/</span> <span class="fu">mean</span>(weight_poststrat)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can visualize the distribution of weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">## quota sample </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_poststrat)) <span class="sc">+</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="css_lab3_solutions_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The distribution of weights looks reasonable. As a general rule of thumb, we don’t want any of weights to be more than 5x larger than our average weight. We don’t observe any extreme weights. If there are extreme weights, a common approach is to “trim” the weights — for instance, any weight greater than 5 is assigned a value of 5.</p>
<p>Now we’re read to calculate the weighted crude death rate estimates. Note that we need to explicitly tell our function what weight column to use (<code>weight_poststrat</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">## crude death rate estimates (kin) - with poststratification weights </span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>kin_estimates_poststrat <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">deaths =</span> <span class="st">"num_deaths_kin"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">degree =</span> <span class="st">"num_total_kin"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">weights =</span> <span class="st">"weight_poststrat"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"kin"</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="do">## crude death rate estimates (neighbour) - with poststratification weights </span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>neighbour_estimates_poststrat <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">deaths =</span> <span class="st">"num_deaths_neighbours"</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">degree =</span> <span class="st">"num_total_neighbour"</span>,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">weights =</span> <span class="st">"weight_poststrat"</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"neighbour"</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine estimates </span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>cdr_poststratification <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(kin_estimates_poststrat, neighbour_estimates_poststrat) <span class="sc">%&gt;%</span> </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weights =</span> <span class="st">"Post-Stratification Weights"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Print out post-stratification estimates </span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>cdr_poststratification</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  death_rate_numerator death_rate_denominator death_rate tie       weights      
                 &lt;dbl&gt;                  &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;        
1                 260.               7041832.      0.370 kin       Post-Stratif…
2                 249.               7700226.      0.324 neighbour Post-Stratif…</code></pre>
</div>
</div>
<p>We can check whether the new post-stratification weighted estimates are higher than the weighted estimates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">## combine crude death rate estimates with unweighted estimates </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>cdr_estimates <span class="ot">&lt;-</span> cdr_poststratification  <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(cdr_unweighted)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualize crude death rate estimates </span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>cdr_estimates <span class="sc">%&gt;%</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> death_rate, <span class="at">x =</span> tie, <span class="at">fill =</span> weights)) <span class="sc">+</span> </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge2</span>(.<span class="dv">3</span>)) <span class="sc">+</span> </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, .<span class="dv">45</span>) <span class="sc">+</span> </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Crude Death Rate </span><span class="sc">\n</span><span class="st"> (per 10,000 person days)"</span>) <span class="sc">+</span> </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> death_rate <span class="sc">+</span> .<span class="dv">02</span>, <span class="at">label =</span> <span class="fu">round</span>(death_rate, <span class="dv">2</span>)), </span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="css_lab3_solutions_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Our post-stratification weights increased our estimates of the crude death rate, but only slightly.</p>
</section>
</section>
<section id="inverse-probability-weights-ipw" class="level2">
<h2 class="anchored" data-anchor-id="inverse-probability-weights-ipw">Inverse probability weights (IPW)</h2>
<p>Our post-stratification weights only account for age class and gender. For example, we may suspect that wealthier individuals are more likely to have social networks with lower mortality.</p>
<p>To better adjust for this, we need our weighting strategy to account for additional dimensions of selection into our sample. However, the challenge with post-stratification is the “curse of dimensionality” — as the number of stratification variables increases, cells become small, sparse, and can produce extremely large and unstable weights.</p>
<p>Instead of post-stratification, we’ll use a model-based approach to estimate each respondent’s probability of inclusion in the non-probability sample. Here we have collected an auxiliary probability-based sample to help with the reweighting.</p>
<p>Specifically, we’ll first combine together our auxiliary probability sample with our non-probability (quota) sample. We’ll then fit a logistic regression predicting inclusion probability in the non-probability sample. We will then use the inverse of this probability as a weight.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read in auxiliary probability sample </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>probability_sample <span class="ot">&lt;-</span> probability_sample <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inclusion =</span> <span class="dv">0</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="do">## create inclusion variable in </span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inclusion =</span> <span class="dv">1</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="do">## pool the sample together </span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>pooled_sample <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(probability_sample, quota_sample)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="do">## fit a logistic regression</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>selection_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(inclusion <span class="sc">~</span> gender <span class="sc">+</span> age_class, <span class="at">data =</span> pooled_sample, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="do">## print summary of model </span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(selection_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = inclusion ~ gender + age_class, family = "binomial", 
    data = pooled_sample)

Coefficients:
                  Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)       -2.59115    0.08000 -32.389  &lt; 2e-16 ***
genderm            0.15713    0.05025   3.127  0.00177 ** 
age_class[25,35)   1.59294    0.08797  18.107  &lt; 2e-16 ***
age_class[35,45)   1.88321    0.08838  21.307  &lt; 2e-16 ***
age_class[45,55)   1.63006    0.09845  16.557  &lt; 2e-16 ***
age_class[55,65)   1.13405    0.12326   9.201  &lt; 2e-16 ***
age_class[65,100]  0.36160    0.18379   1.967  0.04913 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 10365.7  on 9548  degrees of freedom
Residual deviance:  9657.5  on 9542  degrees of freedom
AIC: 9671.5

Number of Fisher Scoring iterations: 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">## generate ipw weights </span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>inclusion_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> selection_model, <span class="at">newdata =</span> quota_sample, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="do">## quota sample </span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_ipw =</span> <span class="dv">1</span><span class="sc">/</span>inclusion_prob) <span class="sc">%&gt;%</span> </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_ipw =</span> weight_ipw<span class="sc">/</span> <span class="fu">mean</span>(weight_ipw)) <span class="do">## normalize weights </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s create a histogram of our inverse probability weights (IPW).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">## histogram of weights </span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span>  </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_ipw)) <span class="sc">+</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="css_lab3_solutions_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The distribution of the weights looks reasonable; there’s no extreme weights. We can now calculate our crude death rate using our new inverse probability weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate cdr with inverse probability weights (kin)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>kin_estimates_ipw <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">deaths =</span> <span class="st">"num_deaths_kin"</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">degree =</span> <span class="st">"num_total_kin"</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">weights =</span> <span class="st">"weight_ipw"</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"kin"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate cdr with inverse probability weights (neighbour)</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>neighbour_estimates_ipw <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">deaths =</span> <span class="st">"num_deaths_neighbours"</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">degree =</span> <span class="st">"num_total_neighbour"</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">weights =</span> <span class="st">"weight_ipw"</span>,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"neighbour"</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="do">## combine together estimates </span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>cdr_ipw <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(kin_estimates_ipw, neighbour_estimates_ipw) <span class="sc">%&gt;%</span> </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weights =</span> <span class="st">"Inverse Probability Weights"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can compare our estimates of the crude death rate using (i) no weights, (ii) poststratification weights, and (iii) inverse probability weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## inverse probability weights </span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>cdr_estimates <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(cdr_ipw) <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">weights =</span> <span class="fu">factor</span>(weights, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Unweighted"</span>, <span class="st">"Post-Stratification Weights"</span>, <span class="st">"Inverse Probability Weights"</span>))) <span class="sc">%&gt;%</span>  <span class="co"># Reorder weights</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> death_rate, <span class="at">x =</span> <span class="fu">reorder</span>(tie, <span class="sc">-</span>death_rate), <span class="at">fill =</span> weights)) <span class="sc">+</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge2</span>(.<span class="dv">3</span>)) <span class="sc">+</span> </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Death Rate"</span>) <span class="sc">+</span> </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> death_rate <span class="sc">+</span> .<span class="dv">02</span>, <span class="at">label =</span> <span class="fu">round</span>(death_rate, <span class="dv">3</span>)), </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="css_lab3_solutions_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Our estimates are very similar regardless of whether we use post-stratification weights or inverse probability weights. However, we have more covariates in our non-probability (and probability sample!) that better capture socioeconomic status (SES), which our theoretical intuition tells us may be important…</p>
<section id="exercise-2-questions" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-questions">Exercise 2 questions:</h3>
<p>We’re worried that our quota sample is over-representing higher SES individuals, which our weights aren’t properly accounting for. To address this, we’ll incorporate additional covariates into our model estimate inclusion probability.</p>
<p><strong>2.1</strong> Recalculate the inverse probability weights using a new logistic regression model with the following additional predictors: <code>manufactured_material_house,</code> <code>bed,</code> <code>radio,</code> and <code>modern_fuel_type</code>. The covariates provide a proxy measure of wealth, measuring whether a respondents home was built with modern construction materials, owning a bed, owning a radio, and using modern fuel for cooking (1 = yes, 0 = no). Are these predictors statistically significant in our new logistic regression model?</p>
<p><strong>2.2</strong> Re-estimate the crude death rate using the new weights (using both kin and neighbour networks). How does your crude death rate change? Make a plot comparing the unweighted estimate, post-stratification estimate, and the new inverse probability weighted estimate.</p>
<p><strong>2.3</strong> Speculate on why our crude death rates change when our inverse probability weights account for SES. What does this tell us about the mortality in the social networks of low vs.&nbsp;high SES respondents?</p>
</section>
<section id="exercise-2-solutions" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-solutions">Exercise 2 solutions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 2.1 </span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="do">## fit a logistic regression model with new covariates </span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>selection_model_ses <span class="ot">&lt;-</span> <span class="fu">glm</span>(inclusion <span class="sc">~</span> gender <span class="sc">+</span> age_class <span class="sc">+</span> manufactured_material_house <span class="sc">+</span> bed <span class="sc">+</span> radio <span class="sc">+</span> modern_fuel_type, <span class="at">data =</span> pooled_sample, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="do">## print summary of new model </span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(selection_model_ses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = inclusion ~ gender + age_class + manufactured_material_house + 
    bed + radio + modern_fuel_type, family = "binomial", data = pooled_sample)

Coefficients:
                            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                 -3.78754    0.09895 -38.279  &lt; 2e-16 ***
genderm                      0.12908    0.05348   2.414   0.0158 *  
age_class[25,35)             1.59513    0.09090  17.548  &lt; 2e-16 ***
age_class[35,45)             2.00840    0.09204  21.822  &lt; 2e-16 ***
age_class[45,55)             1.67193    0.10268  16.283  &lt; 2e-16 ***
age_class[55,65)             1.19974    0.12874   9.319  &lt; 2e-16 ***
age_class[65,100]            0.48244    0.18951   2.546   0.0109 *  
manufactured_material_house  1.28308    0.06001  21.382  &lt; 2e-16 ***
bedyes                       0.91080    0.06614  13.772  &lt; 2e-16 ***
radioyes                     0.02023    0.06001   0.337   0.7361    
modern_fuel_type            -0.24853    0.06322  -3.931 8.45e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 10365.7  on 9548  degrees of freedom
Residual deviance:  8697.8  on 9538  degrees of freedom
AIC: 8719.8

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p><em>Yes, all the new SES coefficients – with the exception of <code>radio</code> – are statistically significant.</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 2.2 </span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">## generate ipw weights </span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>inclusion_prob_ses <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> selection_model_ses, <span class="at">newdata =</span> quota_sample, <span class="at">type =</span> <span class="st">"response"</span>)<span class="sc">/</span><span class="fu">mean</span>(<span class="fu">predict</span>(<span class="at">object =</span> selection_model_ses, <span class="at">newdata =</span> quota_sample, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate ipw weights </span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_ipw_ses =</span> <span class="dv">1</span><span class="sc">/</span>inclusion_prob_ses) </span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="do">## normalize weights </span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>quota_sample <span class="ot">&lt;-</span> quota_sample <span class="sc">%&gt;%</span> </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight_ipw_ses =</span> weight_ipw_ses <span class="sc">/</span> <span class="fu">mean</span>(weight_ipw_ses)) </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="do">## estimate crude death rate using new ipw weights (kin)</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>kin_estimates_ipw <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">deaths =</span> <span class="st">"num_deaths_kin"</span>,</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">degree =</span> <span class="st">"num_total_kin"</span>,</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">weights =</span> <span class="st">"weight_ipw_ses"</span>,</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"kin"</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="do">## estimate crude death rate using new ipw weights (neighbour)</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>neighbour_estimates_ipw <span class="ot">&lt;-</span> <span class="fu">network_survival_estimator</span>(<span class="at">data =</span> quota_sample,</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">deaths =</span> <span class="st">"num_deaths_neighbours"</span>,</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">degree =</span> <span class="st">"num_total_neighbour"</span>,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">weights =</span> <span class="st">"weight_ipw_ses"</span>,</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">exposure_days =</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tie =</span> <span class="st">"neighbour"</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="do">## weights </span></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>cdr_ipw_ses <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(kin_estimates_ipw, neighbour_estimates_ipw) <span class="sc">%&gt;%</span> </span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weights =</span> <span class="st">"Inverse Probability Weights SES"</span>)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="do">## inverse probability weights </span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>cdr_estimates <span class="sc">%&gt;%</span> </span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(cdr_ipw_ses) <span class="sc">%&gt;%</span> </span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">weights =</span> <span class="fu">factor</span>(weights, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Unweighted"</span>, <span class="st">"Post-Stratification Weights"</span>, <span class="st">"Inverse Probability Weights SES"</span>))) <span class="sc">%&gt;%</span>  <span class="co"># Reorder weights</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> death_rate, <span class="at">x =</span> <span class="fu">reorder</span>(tie, <span class="sc">-</span>death_rate), <span class="at">fill =</span> weights)) <span class="sc">+</span> </span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge2</span>(.<span class="dv">3</span>)) <span class="sc">+</span> </span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>,</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Death Rate"</span>) <span class="sc">+</span> </span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> death_rate <span class="sc">+</span> .<span class="dv">02</span>, <span class="at">label =</span> <span class="fu">round</span>(death_rate, <span class="dv">3</span>)), </span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="css_lab3_solutions_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><em>Our estimate of the crude death rate increases when our weights better account of socioeconomic selection.</em></p>
<p><strong>2.3</strong> <em>Our estimates increase when we adjust for socioeconomic status. This suggests that people with low SES (who were underrepresented in our quota survey) have higher mortality in their social networks.</em></p>
</section>
</section>
<section id="bonus-exercise" class="level2">
<h2 class="anchored" data-anchor-id="bonus-exercise">Bonus exercise</h2>
<p>Calculate separate crude death rates for each health zone. Use no weights, post-stratification weights, and inverse probability weights (including SES variables). What health zone has the highest crude death rate?</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>